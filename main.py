import streamlit as st
from PIL import Image
import io
import zipfile

class AndroidImageResizer:
    density_map = {
        "ldpi": 0.75,
        "mdpi": 1.0,
        "hdpi": 1.5,
        "xhdpi": 2.0,
        "xxhdpi": 3.0,
        "xxxhdpi": 4.0
    }

    def __init__(self, base_density: str, target_densities: list[str]):
        self.base_density = base_density
        self.target_densities = target_densities
        self.base_scale = self.density_map[base_density]
        self.logs = []
        self.zip_buffer = io.BytesIO()

    def resize_images(self, files: list[io.BytesIO]):
        with zipfile.ZipFile(self.zip_buffer, "w") as zipf:
            for uploaded_file in files:
                try:
                    img = Image.open(uploaded_file)
                    base_width, base_height = img.size
                    self._log(f"ğŸ–¼ è™•ç†åœ–ç‰‡ï¼š{uploaded_file.name}ï¼ˆ{base_width}x{base_height} pxï¼‰")

                    for density in self.target_densities:
                        resized_img, path_in_zip = self._resize_image(img, uploaded_file.name, density)
                        img_byte_arr = io.BytesIO()
                        resized_img.save(img_byte_arr, format='PNG', optimize=True)
                        img_byte_arr.seek(0)

                        zipf.writestr(path_in_zip, img_byte_arr.read())
                        self._log(f"âœ… {density:<7} â†’ {resized_img.size[0]}x{resized_img.size[1]} px")

                except Exception as e:
                    self._log(f"âŒ éŒ¯èª¤è™•ç†åœ–ç‰‡ {uploaded_file.name}ï¼š{e}")

    def _resize_image(self, img: Image.Image, filename: str, density: str):
        scale_ratio = self.density_map[density] / self.base_scale
        new_size = (int(img.width * scale_ratio), int(img.height * scale_ratio))
        resized_img = img.resize(new_size, Image.LANCZOS)
        path_in_zip = f"drawable-{density}/{filename}"
        return resized_img, path_in_zip

    def get_zip(self) -> bytes:
        self.zip_buffer.seek(0)
        return self.zip_buffer.read()

    def _log(self, message: str):
        self.logs.append(message)

    def show_logs(self):
        for log in self.logs:
            st.write(log)


class ResizerApp:
    def __init__(self):
        self.title = "ğŸ“± Android å¤šå¯†åº¦åœ–ç‰‡è½‰æ›å™¨"
        self.files = []
        self.base_density = "xhdpi"
        self.selected_densities = list(AndroidImageResizer.density_map.keys())

    def run(self):
        st.set_page_config(page_title=self.title)
        st.title(self.title)

        self.files = st.file_uploader("ä¸Šå‚³ PNG åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰", type=["png"], accept_multiple_files=True)
        self.base_density = st.selectbox("åŸå§‹åœ–ç‰‡å¯†åº¦", list(AndroidImageResizer.density_map.keys()), index=3)
        self.selected_densities = st.multiselect(
            "é¸æ“‡è¼¸å‡ºå¯†åº¦", list(AndroidImageResizer.density_map.keys()), default=self.selected_densities
        )

        if st.button("ğŸš€ é–‹å§‹è½‰æ›"):
            self.process_images()

    def process_images(self):
        if not self.files:
            st.error("è«‹å…ˆä¸Šå‚³åœ–ç‰‡")
            return
        if not self.selected_densities:
            st.error("è«‹é¸æ“‡è‡³å°‘ä¸€å€‹è¼¸å‡ºå¯†åº¦")
            return

        resizer = AndroidImageResizer(self.base_density, self.selected_densities)
        resizer.resize_images(self.files)
        resizer.show_logs()

        zip_bytes = resizer.get_zip()
        st.download_button(
            label="ğŸ“¦ ä¸‹è¼‰æ‰€æœ‰è½‰æ›å¾Œåœ–ç‰‡ (ZIP)",
            data=zip_bytes,
            file_name="resized_images.zip",
            mime="application/zip"
        )


if __name__ == "__main__":
    app = ResizerApp()
    app.run()
